import{writeFileSync as d,createReadStream as f}from"fs";import G from"unzipper";import g from"csv-parser";var y=/\d/,_=/\+|_/g,p=/-/g,h=["GLOBALEVENTID","SQLDATE","MonthYear","Year","FractionDate","Actor1Code","Actor1Name","Actor1CountryCode","Actor1KnownGroupCode","Actor1EthnicCode","Actor1Religion1Code","Actor1Religion2Code","Actor1Type1Code","Actor1Type2Code","Actor1Type3Code","Actor2Code","Actor2Name","Actor2CountryCode","Actor2KnownGroupCode","Actor2EthnicCode","Actor2Religion1Code","Actor2Religion2Code","Actor2Type1Code","Actor2Type2Code","Actor2Type3Code","IsRootEvent","EventCode","EventBaseCode","EventRootCode","QuadClass","GoldsteinScale","NumMentions","NumSources","NumArticles","AvgTone","Actor1Geo_Type","Actor1Geo_FullName","Actor1Geo_CountryCode","Actor1Geo_ADM1Code","Actor1Geo_Lat","Actor1Geo_Long","Actor1Geo_FeatureID","Actor2Geo_Type","Actor2Geo_FullName","Actor2Geo_CountryCode","Actor2Geo_ADM1Code","Actor2Geo_Lat","Actor2Geo_Long","Actor2Geo_FeatureID","ActionGeo_Type","ActionGeo_FullName","ActionGeo_CountryCode","ActionGeo_ADM1Code","ActionGeo_Lat","ActionGeo_Long","ActionGeo_FeatureID","DATEADDED","SOURCEURL"];async function R(c){let t=[],u=f(c).pipe(G.Parse({forceStream:!0}));for await(let n of u){let e=n.path.toLowerCase();if(n.type==="File"&&e.endsWith(".csv")){let l=await E(n);t.push(...l)}else n.autodrain()}return t}function a(c,t){return c.length>0&&c.toLowerCase().split(",").forEach(u=>{let n=u.trim();t.indexOf(n)===-1&&t.push(n)}),t}function E(c){return new Promise((t,u)=>{let n=[];c.pipe(g({separator:"	",headers:h})).on("data",e=>{let r=a(e.Actor1Geo_FullName,[]);r=a(e.Actor2Geo_FullName,r),r=a(e.Actor1Name,r),r=a(e.Actor2Name,r);let l=e.SOURCEURL.toLowerCase().replace(_,"-").split("/"),C=l[2],i="";for(let s of l)s.length>i.length&&s.indexOf("?")===-1&&s.indexOf("-")>-1&&(i=s);if(i=i.replace(".html","").replace(".htm","").replace(p," ").trim(),i===""){let s=[];for(let o of l.slice(3)){if(o.length<=1||o==="*")continue;let A=o.indexOf("?");A>-1&&(o=o.substring(0,A)),A=o.indexOf("."),A>-1&&(o=o.substring(0,A)),o.length!==0&&y.test(o)===!1&&s.indexOf(o)===-1&&s.push(o.replace(p," "))}i=s.join(" ")}let m={isRoot:parseInt(e.IsRootEvent),year:parseInt(e.Year),month:parseInt(e.MonthYear.substring(4)),day:parseInt(e.SQLDATE.substring(6)),quad:parseInt(e.QuadClass),goldstein:parseInt(e.GoldsteinScale),mentions:parseInt(e.NumMentions),sources:parseInt(e.NumSources),articles:parseInt(e.NumArticles),tone:parseFloat(e.AvgTone),domain:C,url:e.SOURCEURL,summary:i,entities:r};n.push(m)}).on("end",()=>t(n)).on("error",e=>u(e))})}async function N(){let t=await R("data/20240512.export.CSV.zip");d("output.json",JSON.stringify(t,null,2))}N();
//# sourceMappingURL=index.js.map